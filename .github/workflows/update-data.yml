name: Daily Investment Calendar Update

on:
  schedule:
    - cron: '0 22 * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-data:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Install dependencies
      run: |
        pip install -r scripts/requirements.txt
    
    - name: Ensure directory structure
      run: |
        mkdir -p data/web
        echo "ğŸ“ å½“å‰ç›®å½•ç»“æ„ï¼š"
        ls -la
    
    - name: Check current data status
      id: check_data
      run: |
        echo "ğŸ” æ£€æŸ¥å½“å‰æ•°æ®çŠ¶æ€..."
        
        current_count=0
        for platform in cls jiuyangongshe tonghuashun investing eastmoney; do
          file_path="data/active/current/${platform}.txt"
          if [ -f "$file_path" ] && [ -s "$file_path" ]; then
            current_count=$((current_count + 1))
            echo "âœ… å‘ç° ${platform}.txt"
          else
            echo "âŒ ç¼ºå°‘: ${platform}.txt"
          fi
        done
        
        echo "ğŸ“Š å½“å‰æ•°æ®æ–‡ä»¶: $current_count/5"
        
        if [ $current_count -ge 3 ]; then
          echo "run_mode=daily" >> $GITHUB_OUTPUT
          echo "ğŸ”„ ä½¿ç”¨æ—¥å¸¸æ›´æ–°æ¨¡å¼"
        else
          echo "run_mode=first-run" >> $GITHUB_OUTPUT
          echo "ğŸš€ ä½¿ç”¨é¦–æ¬¡è¿è¡Œæ¨¡å¼"
        fi
    
    - name: Run investment calendar
      run: |
        mode="${{ steps.check_data.outputs.run_mode }}"
        echo "ğŸš€ æ‰§è¡Œæ¨¡å¼: $mode"
        
        if [ "$mode" == "daily" ]; then
          python scripts/daily_calendar.py --daily
        else
          if [ ! -f "data/archived/historical_summary.txt" ]; then
            echo "ğŸ“š å¼€å§‹é‡‡é›†å†å²æ•°æ®..."
            python scripts/historical_collector.py
          fi
          echo "ğŸš€ å¼€å§‹é¦–æ¬¡è¿è¡Œ..."
          python scripts/daily_calendar.py --first-run
        fi
    
    - name: Convert data for web
      run: |
        echo "ğŸ”„ è½¬æ¢æ•°æ®ä¸ºWebæ ¼å¼..."
        python scripts/data_converter.py
        
        echo "ğŸ“Š Webæ•°æ®ç”Ÿæˆç»“æœ:"
        ls -la data/web/ || echo "Webç›®å½•ä¸å­˜åœ¨"
    
    - name: Configure Git
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
    
    - name: Commit and push changes
      run: |
        echo "ğŸ“ å‡†å¤‡æäº¤æ›´æ”¹..."
        
        git add data/web/
        git add data/active/current/metadata.txt 2>/dev/null || echo "æ— å…ƒæ•°æ®æ–‡ä»¶"
        
        if [ -n "$(git status --porcelain)" ]; then
          echo "ğŸ“Š å‘ç°ä»¥ä¸‹å˜æ›´:"
          git status --porcelain
          
          git commit -m "ğŸ“Š Daily data update - $(date +'%Y-%m-%d %H:%M:%S')"
          git push
          echo "âœ… å˜æ›´å·²æäº¤å¹¶æ¨é€åˆ°mainåˆ†æ”¯"
          echo "ğŸŒ GitHub Pageså°†è‡ªåŠ¨éƒ¨ç½²æ›´æ–°"
        else
          echo "â„¹ï¸ æ²¡æœ‰éœ€è¦æäº¤çš„å˜æ›´"
        fi
    
    - name: Deployment info
      run: |
        echo "ğŸ‰ æ•°æ®æ›´æ–°å®Œæˆï¼"
        echo "ğŸŒ ç½‘ç«™å°†åœ¨å‡ åˆ†é’Ÿå†…è‡ªåŠ¨æ›´æ–°"
        echo "ğŸ“ è®¿é—®åœ°å€: https://lijiang-0920.github.io/investment-calendar/"
