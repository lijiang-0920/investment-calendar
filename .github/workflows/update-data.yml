name: Daily Investment Calendar Update

on:
  schedule:
    # æ¯å¤©åŒ—äº¬æ—¶é—´ 6:00 (UTC 22:00) æ‰§è¡Œ
    - cron: '0 22 * * *'
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  update-data:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Install dependencies
      run: |
        pip install -r scripts/requirements.txt
    
    - name: Check if historical data exists
      id: check_historical
      run: |
        if [ -d "data/archived" ] && [ "$(find data/archived -name '*.txt' 2>/dev/null | wc -l)" -gt 0 ]; then
          echo "has_historical=true" >> $GITHUB_OUTPUT
        else
          echo "has_historical=false" >> $GITHUB_OUTPUT
        fi
    
    - name: Check if current data exists
      id: check_current
      run: |
        count=0
        for platform in cls jiuyangongshe tonghuashun investing eastmoney; do
          if [ -f "data/active/current/${platform}.txt" ]; then
            count=$((count + 1))
          fi
        done
        
        if [ $count -lt 3 ]; then
          echo "has_current=false" >> $GITHUB_OUTPUT
        else
          echo "has_current=true" >> $GITHUB_OUTPUT
        fi
    
    - name: Run historical data collection (if no historical data)
      if: steps.check_historical.outputs.has_historical == 'false'
      run: |
        cd scripts
        echo "ðŸ•’ å¼€å§‹é‡‡é›†åŽ†å²æ•°æ®..."
        python historical_collector.py
    
    - name: Run first-time setup (if no current data)
      if: steps.check_current.outputs.has_current == 'false'
      run: |
        cd scripts
        echo "ðŸš€ é¦–æ¬¡è¿è¡Œæ¨¡å¼..."
        python daily_calendar.py --first-run
    
    - name: Run daily update (if has current data)
      if: steps.check_current.outputs.has_current == 'true'
      run: |
        cd scripts
        echo "ðŸ”„ æ—¥å¸¸æ›´æ–°æ¨¡å¼..."
        python daily_calendar.py --daily
    
    - name: Convert data for web
      run: |
        cd scripts
        echo "ðŸ”„ è½¬æ¢æ•°æ®ä¸ºWebæ ¼å¼..."
        python data_converter.py
    
    - name: Configure Git
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
    
    - name: Commit and push changes
      run: |
        git add data/web/
        git add data/active/current/metadata.txt
        # å¦‚æžœæ˜¯é¦–æ¬¡è¿è¡Œï¼Œä¹Ÿæäº¤ä¸€äº›å…³é”®æ•°æ®æ–‡ä»¶
        if [ "${{ steps.check_current.outputs.has_current }}" == "false" ]; then
          git add data/active/current/*.txt
        fi
        
        if [ -n "$(git status --porcelain)" ]; then
          git commit -m "ðŸ“Š Daily data update - $(date +'%Y-%m-%d %H:%M:%S')"
          git push
        else
          echo "No changes to commit"
        fi
    
    - name: Update deployment status
      run: |
        echo "Deployment completed at $(date)" > deployment_status.txt
        git add deployment_status.txt
        git commit -m "ðŸš€ Update deployment status" || echo "No status changes"
        git push || echo "No status push needed"

  deploy:
    needs: update-data
    runs-on: ubuntu-latest
    
    steps:
    - name: Deploy to GitHub Pages
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./
        exclude_assets: 'scripts/**,.github/**'
