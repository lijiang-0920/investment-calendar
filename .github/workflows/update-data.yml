name: Daily Investment Calendar Update

on:
  schedule:
    - cron: '0 22 * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-data:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Install dependencies
      run: |
        pip install -r scripts/requirements.txt
    
    - name: Ensure directory structure
      run: |
        mkdir -p data/web
        echo "📁 当前目录结构："
        ls -la
    
    - name: Check current data status
      id: check_data
      run: |
        echo "🔍 检查当前数据状态..."
        
        current_count=0
        for platform in cls jiuyangongshe tonghuashun investing eastmoney; do
          file_path="data/active/current/${platform}.txt"
          if [ -f "$file_path" ] && [ -s "$file_path" ]; then
            current_count=$((current_count + 1))
            echo "✅ 发现 ${platform}.txt"
          else
            echo "❌ 缺少: ${platform}.txt"
          fi
        done
        
        echo "📊 当前数据文件: $current_count/5"
        
        if [ $current_count -ge 3 ]; then
          echo "run_mode=daily" >> $GITHUB_OUTPUT
          echo "🔄 使用日常更新模式"
        else
          echo "run_mode=first-run" >> $GITHUB_OUTPUT
          echo "🚀 使用首次运行模式"
        fi
    
    - name: Run investment calendar
      run: |
        mode="${{ steps.check_data.outputs.run_mode }}"
        echo "🚀 执行模式: $mode"
        
        if [ "$mode" == "daily" ]; then
          python scripts/daily_calendar.py --daily
        else
          if [ ! -f "data/archived/historical_summary.txt" ]; then
            echo "📚 开始采集历史数据..."
            python scripts/historical_collector.py
          fi
          echo "🚀 开始首次运行..."
          python scripts/daily_calendar.py --first-run
        fi
    
    - name: Convert data for web
      run: |
        echo "🔄 转换数据为Web格式..."
        python scripts/data_converter.py
        
        echo "📊 Web数据生成结果:"
        ls -la data/web/ || echo "Web目录不存在"
    
    - name: Configure Git
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
    
    - name: Commit and push changes
      run: |
        echo "📝 准备提交更改..."
        
        git add data/web/
        git add data/active/current/metadata.txt 2>/dev/null || echo "无元数据文件"
        
        if [ -n "$(git status --porcelain)" ]; then
          echo "📊 发现以下变更:"
          git status --porcelain
          
          git commit -m "📊 Daily data update - $(date +'%Y-%m-%d %H:%M:%S')"
          git push
          echo "✅ 变更已提交并推送到main分支"
          echo "🌐 GitHub Pages将自动部署更新"
        else
          echo "ℹ️ 没有需要提交的变更"
        fi
    
    - name: Deployment info
      run: |
        echo "🎉 数据更新完成！"
        echo "🌐 网站将在几分钟内自动更新"
        echo "📍 访问地址: https://lijiang-0920.github.io/investment-calendar/"
