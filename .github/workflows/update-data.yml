name: Daily Investment Calendar Update

on:
  schedule:
    # æ¯å¤©åŒ—äº¬æ—¶é—´ 6:00 (UTC 22:00) æ‰§è¡Œ
    - cron: '0 22 * * *'
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  update-data:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Install dependencies
      run: |
        pip install -r scripts/requirements.txt
    
    - name: Ensure directory structure
      run: |
        mkdir -p data/web
        ls -la data/
        echo "ğŸ“ æ£€æŸ¥dataç›®å½•ç»“æ„ï¼š"
        find data/ -type f -name "*.txt" | head -10
    
    - name: Check current data status
      id: check_data
      run: |
        echo "ğŸ” æ£€æŸ¥å½“å‰æ•°æ®çŠ¶æ€..."
        
        # æ£€æŸ¥currentç›®å½•ä¸­çš„å¹³å°æ–‡ä»¶
        current_count=0
        for platform in cls jiuyangongshe tonghuashun investing eastmoney; do
          file_path="data/active/current/${platform}.txt"
          if [ -f "$file_path" ] && [ -s "$file_path" ]; then
            current_count=$((current_count + 1))
            echo "âœ… å‘ç° ${platform}.txt ($(stat -c%s "$file_path") bytes)"
          else
            echo "âŒ ç¼ºå°‘æˆ–ä¸ºç©º: ${platform}.txt"
          fi
        done
        
        # æ£€æŸ¥å†å²æ•°æ®
        archived_count=$(find data/archived -name "*.txt" 2>/dev/null | wc -l)
        
        echo "ğŸ“Š æ•°æ®ç»Ÿè®¡:"
        echo "  - å½“å‰æ•°æ®æ–‡ä»¶: $current_count/5"
        echo "  - å†å²æ•°æ®æ–‡ä»¶: $archived_count"
        
        # å†³å®šè¿è¡Œæ¨¡å¼
        if [ $current_count -ge 3 ]; then
          echo "run_mode=daily" >> $GITHUB_OUTPUT
          echo "ğŸ”„ ä½¿ç”¨æ—¥å¸¸æ›´æ–°æ¨¡å¼"
        else
          echo "run_mode=first-run" >> $GITHUB_OUTPUT
          echo "ğŸš€ ä½¿ç”¨é¦–æ¬¡è¿è¡Œæ¨¡å¼"
        fi
    
    - name: Run investment calendar
      run: |
        # ä¸è¦cdåˆ°scriptsç›®å½•ï¼Œåœ¨æ ¹ç›®å½•è¿è¡Œ
        mode="${{ steps.check_data.outputs.run_mode }}"
        echo "ğŸš€ æ‰§è¡Œæ¨¡å¼: $mode"
        
        if [ "$mode" == "daily" ]; then
          python scripts/daily_calendar.py --daily
        else
          if [ ! -f "data/archived/historical_summary.txt" ]; then
            echo "ğŸ“š å¼€å§‹é‡‡é›†å†å²æ•°æ®..."
            python scripts/historical_collector.py
          fi
          echo "ğŸš€ å¼€å§‹é¦–æ¬¡è¿è¡Œ..."
          python scripts/daily_calendar.py --first-run
        fi
    
    - name: Convert data for web
      run: |
        echo "ğŸ”„ è½¬æ¢æ•°æ®ä¸ºWebæ ¼å¼..."
        python scripts/data_converter.py
        
        echo "ğŸ“Š Webæ•°æ®ç”Ÿæˆç»“æœ:"
        ls -la data/web/ || echo "Webç›®å½•ä¸å­˜åœ¨"

    
    - name: Configure Git
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
    
    - name: Commit and push changes
      run: |
        echo "ğŸ“ å‡†å¤‡æäº¤æ›´æ”¹..."
        
        # æ·»åŠ webæ•°æ®ï¼ˆè¿™æ˜¯ç½‘é¡µå¿…éœ€çš„ï¼‰
        git add data/web/
        
        # æ·»åŠ å…ƒæ•°æ®
        git add data/active/current/metadata.txt 2>/dev/null || echo "æ— å…ƒæ•°æ®æ–‡ä»¶"
        
        # æ£€æŸ¥å˜æ›´
        if [ -n "$(git status --porcelain)" ]; then
          echo "ğŸ“Š å‘ç°ä»¥ä¸‹å˜æ›´:"
          git status --porcelain
          
          git commit -m "ğŸ“Š Daily data update - $(date +'%Y-%m-%d %H:%M:%S')"
          git push
          echo "âœ… å˜æ›´å·²æäº¤å¹¶æ¨é€"
        else
          echo "â„¹ï¸ æ²¡æœ‰éœ€è¦æäº¤çš„å˜æ›´"
        fi
    
    - name: Deployment summary
      run: |
        echo "ğŸ‰ éƒ¨ç½²å®Œæˆ!"
        echo "ğŸ“Š æœ€ç»ˆçŠ¶æ€:"
        echo "  - è¿è¡Œæ¨¡å¼: ${{ steps.check_data.outputs.run_mode }}"
        echo "  - Webæ•°æ®: $(ls data/web/*.json 2>/dev/null | wc -l) ä¸ªJSONæ–‡ä»¶"
        echo "  - ç½‘ç«™åœ°å€: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/"

  deploy:
    needs: update-data
    runs-on: ubuntu-latest
    
    steps:
    - name: Deploy to GitHub Pages
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./
        exclude_assets: 'scripts/**,.github/**'
