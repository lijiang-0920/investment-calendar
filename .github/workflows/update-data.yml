name: Daily Investment Calendar Update

on:
  schedule:
    - cron: '0 22 * * *'
  workflow_dispatch:

jobs:
  update-data:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Install dependencies
      run: |
        pip install -r scripts/requirements.txt
    
    - name: Check if first run
      id: check_first_run
      run: |
        # 检查是否有足够的数据文件
        count=0
        for platform in cls jiuyangongshe tonghuashun investing eastmoney; do
          if [ -f "data/active/current/${platform}.txt" ]; then
            count=$((count + 1))
          fi
        done
        
        if [ $count -lt 3 ]; then
          echo "first_run=true" >> $GITHUB_OUTPUT
        else
          echo "first_run=false" >> $GITHUB_OUTPUT
        fi
    
    - name: Run historical data collection (first time only)
      if: steps.check_first_run.outputs.first_run == 'true'
      run: |
        cd scripts
        python historical_collector.py
    
    - name: Run daily update
      run: |
        cd scripts
        if [ "${{ steps.check_first_run.outputs.first_run }}" == "true" ]; then
          python daily_calendar.py --first-run
        else
          python daily_calendar.py --daily
        fi
    
    - name: Convert data for web
      run: |
        cd scripts
        python data_converter.py
    
    - name: Configure Git
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
    
    # 只提交web数据，不提交原始数据
    - name: Commit and push changes
      run: |
        git add data/web/
        git add data/active/current/metadata.txt
        if [ -n "$(git status --porcelain)" ]; then
          git commit -m "📊 Daily data update - $(date +'%Y-%m-%d %H:%M:%S')"
          git push
        else
          echo "No changes to commit"
        fi
